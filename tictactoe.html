<!DOCTYPE html>
<html>
<head>
<title>Tic Tac Toe</title>
    <script
        src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js">
    </script>

    <script>
    size = 3;  // should have global scope...
    marks = ['X', 'O'];//, 'y', 'Z', 'W'];  // should start with X, can be extended...
    currentMark = 0; // counter for keeping track of which mark to make
    buttons = [];  // use jquery to get all in the class instead of array?
    empty = " ";   // value for an empty box

    $(document).ready(function () {
        // Make the boxes
        makeBoard();
        setupWinner();

        // also set up the players to detect a win
        // remake the board for a new game when clicked.
        $("#btnNewGame").click(function (){
            for(var i = 0; i < size; i++){
                for(var j = 0; j < size; j++){
                    buttons[i][j].val(empty);
                }
            }
            setupWinner();
        });

        // Set up the user selection of the board
        $("#playerSubmit").click(function(){
            size = parseInt($("#userSize").val());
            nplayers = parseInt($("#numPlayers").val());

            // reset the marks
            marks = ['X', 'O', 'y', 'Z', 'W'];
            marks = marks.slice(0, nplayers);

            resetBoard();
        });

    });

    function resetBoard(){
        // reset the buttons
        $(".playBtn").remove();
        $("#XO").html('');

        currentMark = 0; // counter for keeping track of which mark to make
        buttons = [];  // use jquery to get all in the class instead of array?

        buttons = [];
        scores = [];

        makeBoard();
        setupWinner();

    }

    function setupWinner(){
        // rows and columns
        // in scores we will start with rows then go to columns then diagionals
        scores = [];
        players = [];
        scoreMarks = [];
        for(var i = 0; i < size * 2; i++){
            scores.push(0);
        }

        // add in the diagionals
        scores.push(0);
        scores.push(0);

        scoreMarks.push(1);
        players.push(size);  // first players mark is always one

        for(var p = 0; p < marks.length - 1; p++){
            var nextNum = players[players.length -1] + 1;
            console.log(nextNum);
            players.push(nextNum * size);
            scoreMarks.push(nextNum);
        }
    }

    /**
     * @description Will try to detect a win on the board
     * @return if it detected a win or not...
     */
    function detectWin(){
        console.log("Looking for win");
        for(var i = 0; i < scores.length; i++){
            if (findOne(players, scores)){
                alert("The game is over, Player " + marks[currentMark] + "wins.");
                console.log("The game is over, Player " + marks[currentMark] + "wins.");

                return true;
            }
            return false;
        }

    }

    /**
     * @description determine if an array contains one or more items from
     *    another array.
     * @param {array} haystack the array to search.
     * @param {array} arr the array providing items to check for in the
     *    haystack.
     * @return {boolean} true|false if haystack contains at least one item
     *    from arr.
     */
    var findOne = function (haystack, arr) {
        return arr.some(function (v) {
            return haystack.indexOf(v) >= 0;
        });
    };

    /**
     * @description Function to create the board initially, make 2d array of
     *   buttons too
     */
    function makeBoard(){
        for(var i = 0; i < size; i++){
            var row = [];
            for(var j = 0; j < size; j++){
                var num = i + '_' + j;
                var $button = $('<input type="button" id='+num+' class="playBtn" value=" "/>');
                console.log(num);
                $button.appendTo($('#XO'));
                buttonHook(num);
                row.push($button);
            }
            var $newLine = $('<br /><br />');
            $newLine.appendTo($('#XO'));
            buttons.push(row);
        }
    }  // end makeBoard


    /**
     * @description Function to hook up all of the buttons to clicking and
     *   displaying
     */
    function buttonHook(id){
        // hook up the buttons on the board
        $("#XO input").css({ 'height': '100px', 'width': '100px',
                             'font-size': '75px'  });
        $('#'+id).click(function() {
            // Check to make sure we can click it...
            if ($.inArray($('#'+id).val(), marks ) > -1){
                alert("Already taken!");
            } else {
                $('#'+id).val(marks[currentMark]);
                console.log("Clicked " + $(this).attr('id'));

                // set up the indicies to populate the scores
                idx = id.split('_');
                idx[0] = parseInt(idx[0]);
                idx[1] = parseInt(idx[1]);
                // mark the row
                scores[idx[0]] += scoreMarks[currentMark];

                // mark the column
                console.log("Adding: " + scoreMarks[currentMark],idx, size + idx[1],size);
                scores[idx[1] + size] += scoreMarks[currentMark];

                // mark diagional
                if (idx[0] - idx[1] == 0){
                    scores[scores.length - 2] += scoreMarks[currentMark];
                    console.log("Diagional ", scores);
                }
                if (idx[0] + idx[0] == size + 1){
                    scores[scores.length -1] += scoreMarks[currentMark];
                    console.log("Diagional 2 ", scores);
                }

                if (detectWin()){
                    resetBoard();
                } else {
                    // increment the mark
                    currentMark ++;
                    currentMark = currentMark % marks.length;
                }
            }
        })
    }  // end buttonHook

    </script>
</head>
<body>
    <!--    <form action="demo_form.asp"> -->
        Number of players: <input type="text" name="numPlayers" id="numPlayers" value="2"><br>
        size: <input type="text" name="userSize" value="3" id="userSize"><br>
        <input type="submit" value="Submit" id="playerSubmit">
    </form>
    <br><br />
    <div id="XO">
        <!-- added dynamically -->
    </div>
    <input type="button" id="btnNewGame" value="New Game" />
</body>
</html>
